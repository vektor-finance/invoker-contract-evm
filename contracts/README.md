# Contract Compatability

**TABLE OF CONTENTS**

- [Bridge](#bridge)
- [LP](#lp)
    - [Uniswap V2](#uniswap-v2)
    - [Curve](#curve)
    - [Uniswap V3](#uniswap-v3)
- [Move](#move)
    - [Supported Assets](#supported-asset-types)
    - [Compatability Issues](#known-compatability-issues)
- [Swap](#swap)
    - [Uniswap V2](#uniswap-v2-1)
    - [Curve](#curve-1)
    - [Uniswap V3](#uniswap-v3-1)

# Bridge

**UNSUPPORTED**

# LP

Allow assets to be added/removed from liquidity pools.

Different protocols allow for different methods for providing/withdrawing liquidity. These will be discussed in detail within the protocol subsection. When adding/removing liquidity, there also exists a form of slippage although this is subtly different to the slippage experienced when performing BUY/SELL. Given that liquidity pools are utilised for trading, the ratio of prices between assets within the pool can change before the add/remove liquidity transaction is mined. This deviation in price is what can be controlled by providing a slippage parameter.

## Uniswap V2

Note: "Uniswap V2" refers to the venue type, rather than the venue itself.

Uniswap V2 pools consist of two ERC20 tokens. In order to add liquidity, these two tokens must be provided at a 50:50 ratio. The ratio is determined by the current ratio of the reserves of these assets (number of tokens within the pool). Users receive an `LP token` which represents their share of the liquidity pools. When removing liquidity, these LP tokens are burned, and the underlying assets sent to the user in the same ratio. Trading fees result in the number of underlying assets per LP token increasing, and are therefore handled automatically.

### Supported Pools

All Uniswap V2 pools are supported. Pools with Fee-on-Transfer tokens are not supported.

### Known Compatability Issues

- Fee-on-Transfer tokens not supported

## Curve

Curve pools consist of up to eight ERC20 tokens. Assets within a pool are often stable priced, with minimal deviation in price. The price of an individual asset is determined by the StableSwap invariant, rather than the ratio of assets within the pool. Users also receive an `LP token` when adding liquidity which represents their share of the liquidity pool. Trading fees result in the number of underlying assets per lp token increasing, and are therefore handled automatically. 

### Supported Pools

Each Curve Pool has a custom implementation. Although they broadly follow the same interface, we would want each pool to be tested extensively before we can say a pool is supported. In order to avoid spending time testing all pools individually, we should instead prioritise specific pools. The following table represents the pools which have been tested:

| pool | assets | TVL | status |
| --- | --- | --- | --- |
| 3pool | DAI, USDC, USDT | $1.6b | Able to add/withdraw liquidity |
| slink | LINK, SLINK | $3.3m | Able to add/withdraw liquidity |
| compound | cDAI, cUSDC | $91.6m | Able to add/withdraw liquidity directly (via cToken) <br> Able to add/withdraw liquidity indirectly (via DAI/USDC) 
| aave | aDAI, aUSDC, aUSDT | $38.1m | Able to add/withdraw liquidity directly (via aToken) <br> Able to add/withdraw liquidity indirectly (via DAI, USDC, USDT)


### Known Compatability Issues

Any pool not mentioned in the above table 'Supported Pools' must be considered to be unsupported.

#### Metapools

These pools expand on the curve 3pool. One example is the FRAX pool, which contains two tokens: the 3pool token, and FRAX token. Although the underlying assets for this pool are DAI, USDC, USDT and FRAX the actual pool itself has two tokens (3pool, FRAX). At present, these pools are untested and therefore unsupported.

#### No support for Curve LP Gauge

Additional fees can be generated by staking LP tokens within a Liquidity Gauge (curve contract). This falls under the category of "staking" LP tokens, and is not supported as part of LPing.

## Uniswap V3

Uniswap V3 introduces the concept of concentrated liquidity by allows users to provide liquidity within a specific `range`. A range is defined by a `lowerTick` and `upperTick` parameter. Uniswap V3 allows for the creation of multiple pools for two ERC20 tokens which have different fees. At present, the permitted fees are those within `[0.01%, 0.05%, 0.3%, 1%]`.

Adding liquidity to a Uniswap V3 pool within a specific range results in a `position`. There can exist multiple positions within a specific pool, and these positions are unique to each other. These positions are therefore `non-fungible` and are not represented by LP tokens, instead they are represented by a `position NFT`.

Because of this NFT structure, there are different functions for interacting with positions. These include:

Adding liquidity to a Uniswap V3 pool has two meanings:
- Creating a new position
- Adding liquidity to a pre-existing position (must be within the same range)

Removing liquidity can also mean two different things:
- Remove *some* liquidity from a position, keeping the original position
- Removing *all* liquidity from a position, burning the NFT in the process

Fees must be manually collected from a position. Fee collection occurs automatically when withdrawing liquidity.

### Supported Pools

All Uniswap V3 pools are supported. Pools with Fee-on-Transfer tokens are not supported.

### Known Compatability Issues

- Fee-on-Transfer tokens not supported

# Move

Allows assets to be transferred to/from the invoker.

For security purposes, we do not allow users to transfer assets directly between users. In order to transfer an asset between user `A` and user `B`, you must first transfer the asset from user `A` to the invoker and then transfer from the invoker to user `B`.

:bangbang: It is the responsibility of the calling function to ensure that assets which are transferred to the invoker are subsequently returned to the correct user within the same transaction. If this does not happen, the assets will be lost.

## Supported Asset types

- Native Token - This is the token used to pay for gas/network fees.
        
    Unsure compatibility for blockchain networks which utilise ERC20 tokens to pay for gas

- Standard ERC20 Token - This includes tokens which conform to [EIP-20](https://eips.ethereum.org/EIPS/eip-20). Note: some tokens do not follow the behaviour in an expected manner. These are listed below.
    - Non-confirming ERC20 tokens which do not return a `bool` on transfer/approval are supported. Tokens of this type include: USDT, OmiseGo, BNB(mainnet).

- Standard ERC721 Token (NFT) - This includes tokens which conform to [EIP-721](https://eips.ethereum.org/EIPS/eip-721).

## Known compatability issues

### ERC20
     
#### Deflationary / Fee-on-transfer tokens

These include tokens where the transferred amount and received amount are not identical. Any transfer using these tokens will revert. It is possible to enable this token class in the future. Possible causes could include:
- Percentage of tokens transferred is burned (deflationary)
- Percentage of tokens transferred is sent to a separate address (fee-on-transfer)

#### Rebasing / Elastic Supply tokens

There are many flavours of rebasing tokens, some of which are advertised as rebasing tokens (AMPL or OHM), others which are not immediately obvious (stETH). 
    
A standard ERC20 token uses a `mapping (address => uint256) balance`. Rebasing tokens instead issue a 'share' such that `share * shareMultiplier == balance`. Due to rounding errors, this causes the same issue with fee-on-transfer tokens.  
Consider the following example: 
    
> The current shareMultiplier ratio is `1.1`  
A user mints himself a balance of `100`. The contract performs `100/1.1` which issues the user with `90` shares (rounding is truncated).  
When attempting to transfer his `100` tokens, he actually only has a balance of `99` as `90` shares * `1.1` multipler  
Contract reverts

# Swap

Allows assets to be swapped for other assets. We define the following:
- SELL: The user specifies an exact amount of an input token
- BUY: The user specifies an exact amount of an output token

There is often a delay between transaction signing and transaction confirmation (minimum is the blocktime, however could be much longer depending on network conditions). It is therefore necessary to supply a `minAmountOut/maxAmountIn` parameter which indicates the threshold amount of the desired asset to be received/offered before the transaction reverts. This refers to different assets for SELL/BUY

## Uniswap V2

Note: "uniswap v2" refers to the venue type, rather than the venue itself.

### Supported pool types

All Uniswap V2 pools are compatible.

### Known compatibility issues

#### Imbalanced pools

Some Uniswap pools are `imbalanced` or `out-of-sync`. It is still possible to trade within these pools, however the price calculated by the OrderRouter for these pools may be different to the actual executed price. Transactions may therefore revert due to the slippage parameter. This occurs rarely, and is usually caused by one of the tokens within the pool having unexpected behaviour. These pools should be avoided.

## Curve

### Supported pool types

Curve pools that have been deployed by curve team are supported (ie. excluding factory pools).

### Known compatability issues

#### ETH pools

There are a few pools which utilise native ether and these are not currently supported.
These pools include:

| pool | assets | TVL
| --- | --- | --- |
| steth | ETH - stETH | $293.4m |
| seth | ETH - sETH | $18.6m |
| ankreth | ETH - ankrETH | $41,163 |
| reth | ETH - rETH | $3727 |

#### Factory Pools

A recent update to Curve has allowed for permisionless pool creation. These are called 'factory pools' and are demonstrated on the curve UI by the text `FACTORY`. At present, they are not supported.

## Uniswap V3

### Supported pools

All Uniswap V3 pools are supported. 

### Known compatability issues

No known issues

It is unknown whether there exists any compatibility issue with fee-on-transfer tokens as in uniswap V2. 
